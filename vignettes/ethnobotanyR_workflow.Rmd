---
title: "Suggested workflow using ethnobotanyR"
author: "Cory Whitney"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Ethnobotany workflow using ethnobotanyR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# ethnobotanyR 

<p align="center">
<img src="ethnobotanyR.png" height="256" style="background:none; border:none; box-shadow:none;">
</p>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(causaleffect)
library(broom)
library(dplyr)
library(ethnobotanyR)
library(igraph)
library(magrittr)
library(pbapply)
library(purrr)
library(stringr)
library(Taxonstand)
library(tidyr)
library(vegan)
```

## Addressing issues of relevance to communities

Ideally the work that we do will have direct relevance to the communities that are involved. It is far better for development related work to be done with, rather than about, communities. Ethnobotany work often concerns people who are faced with uncertain decisions about how to manage natural resources. Our work should, ideally, be aimed at helping to give some clarity for these decisions. Trade-offs have to be made between the natural world and human development. These trade-offs should be discussed and the detriments to either human society or ecology should be mitigated. Our work in ethnobotany can help to make these trade-offs clear and help to support decision making so that it has the best outcomes for society and the natural world. 

We should do our work so that it serves local communities. The best way to make sure that our work is of direct relevance to communities is to start our process with local people, rather than developing our research agenda at our desks we should do it cooperatively with the broad interests of local communities in mind. 

## Impact pathway 

Building a causal model of the problem at hand can be useful when working together with communities to define meaningful research questions. The decision will take the form of a causal decision impact pathway. Here is a simplified example of the effect of allowing for forest use (i.e. active practice of ethnobotany uses) on the conservation of a forest given the risk of overextraction and the possible benefit of conservation actions on the part of the users. This can be plotted with the `igraph` library.

```{r plot_conservation_decision, fig.width=7, fig.height=7}
#decision impact pathway

conservation_decision <- igraph::graph.formula(UF -+  CA, #use_forests -+ conservation_action,
                                    UF -+  OE, #use_forests -+ overextraction,
                                    OE -+  C, #overextraction -+ conservation,
                                    CA -+  C, #conservation_action -+ conservation,
                   simplify = FALSE)

plot(conservation_decision)
```

The `causal.effect()` function of the `causalimpact` library uses the doCalculus methods to generate a formula for the causal impact pathway. This model can be fed with observed values, ethnobotany surveys, focus group discussions and interviews.

```{r}
causaleffect_model <- causaleffect::causal.effect(y = "C", x = "UF", z = NULL, G = conservation_decision, expr = TRUE)
```

```{r get_formula, include=FALSE}
#Concatenate and Print model
cat(causaleffect_model)
```

$P_{C}(UF) = \sum_{CA,OE}P(C|UF,CA,OE)*P(OE|UF)P(CA|UF)$

## Testing various hypotheses in ethnobotany

Users are highly encouraged to read the theory papers of Albuquerque et al. (2019) and Gaoue et al. (2017). Both papers offer helpful guidance to understanding theoretical approaches in ethnobotany, which are helpful in formulating useful research questions. The DCA and PCA may be useful for exploratory analysis of ethnobotany data but should be used with caution and within the confines of the predetermined research aims and objectives.

### Detrended correspondence analysis (DCA)

Detrended correspondence analysis (DCA) can be used to find the main factors or 'gradients' in large and sparse community datasets. This can be a useful tool for assessing important informant-species-use associations in ethnobotany. Here we use the  dataset presented in `ethnobotanydata` to perform DCA using the `decorana()` function in the `vegan` package in R. 

The first step is to remove zero value row sums. The DCA can only work with data that is complete (i.e. we remove all NA cases as well as those where the species is listed by an informant but no specific use is recorded).

```{r }
#remove rows with zero rowsums
ethno_data_complete <- ethnobotanydata %>%  
  dplyr::select(-informant, -sp_name) %>% 
    dplyr::filter_all(any_vars(. != 0))

 ethno_ordination <- vegan::decorana(ethno_data_complete) #This saves ordination results

 
 ethno_ordination
```

Ordination results are shown with `summary(ord)`. Scores are extracted with `scores`. Vegan's plot function automatically shows the scores.

```{r plot_ord, fig.width=7, fig.height=7}
#Plot ordination results
plot(ethno_ordination)
```

## Principal component analysis (PCA)

Principal component analysis (PCA) can be used to create sets of linearly uncorrelated variables from cases of informant-species-use associations. The resulting principal components are linear combinations of variables that are fed in and each contain all observations. We perform PCA using the `tidyverse` and `broom` packages using the `nest()` function along with the `mutate()` and `map` combo to operate on the nested columns. This gives a `tibble` with one row and three columns: 1. our original data set, 2. the `prcomp` object and 3. a data frame of principal component values for each observation.

```{r nesting}
nested_ethno_pca <- ethnobotanydata %>% 
  tidyr::nest() %>% 
  dplyr::mutate(pca = purrr::map(data, ~ stats::prcomp(.x %>% 
        dplyr::select(-informant, -sp_name), 
        center = TRUE, scale = TRUE)),
         pca_augmented = map2(pca, data, ~broom::augment(.x, data = .y)))

nested_ethno_pca
```

For PCA model evaluation we can check to see how much variance is explained by each principal component. This tells us how many of the components would be reasonable to assess when analyzing the results. To do this, we can use the data in the `pca_augmented` column of our `nested_ethno_pca` tibble along with some `dplyr` functions.

```{r variance_check}

var_exp_tidy <- nested_ethno_pca %>% 
  tidyr::unnest(pca_augmented) %>% 
  dplyr::summarize_at(.vars = vars(contains("PC")), .funs = funs(var)) %>% 
  tidyr::gather(key = pc, value = variance) %>% 
  dplyr::mutate(var_exp = variance/sum(variance),
         cum_var_exp = cumsum(var_exp),
         pc = stringr::str_replace(pc, ".fitted", ""))

var_exp_tidy
```

The `nrow(var_exp_tidy)` principle components selected explain `sum(var_exp_tidy$var_exp)`% of variance. As a general rule the first few principal components explain much of the variation. To keep the analysis within reasonable bounds it makes sense to select the first four principle components.

```{r select_components}

var_exp <- var_exp_tidy %>% 
  head(4)

var_exp
```

Plot the variance explained and the cumulative variance explained to see trends across components.

```{r plot_pca, fig.width=7, fig.height=7}
var_exp %>% 
  dplyr::rename(
    `Variance Explained` = var_exp,
    `Cumulative Variance Explained` = cum_var_exp
  ) %>% 
  tidyr::gather(key = key, value = value, `Variance Explained`:`Cumulative Variance Explained`) %>% 
  ggplot2::ggplot(ggplot2::aes(pc, value, group = key)) + 
  ggplot2::geom_point() + 
  ggplot2::geom_line() + 
  ggplot2::facet_wrap(~key, scales = "free_y") +
  ggplot2::theme_minimal() +
  ggplot2::lims(y = c(0, 1)) +
  ggplot2::labs(y = "Variance",
       title = "Variance explained by each principal component")

```

## Getting Species names right

Another, possibly equally important part of ethnobotany, is that we are good practitioners. This means attaining as much as possible a mastery of the tools needed for the job. A large part of the work of ethnobotany is identification of species.

Plant species names are changing all the time. As botanists learn more about the diversity of plant life the taxonomic record becomes more clear and different species groups are often split or merged. These changes are most accurately, and most timely, dispalyed on The Plant List <http://www.theplantlist.org/> maintained by the Missouri Botanical Garden. 

Among the many other functions, the R package Taxonstand can cross-check .csv based lists of species names against the database. Here is an example using just the species names `Full.name` in Taxonstand's `bryophytes` data.

```{r bryophytes_head, echo= FALSE}
data(bryophytes)

 bryophytes_short <- bryophytes %>% 
  head(6)

knitr::kable(bryophytes_short$Full.name, caption = "First six rows of Taxonstand's bryophytes species list")
```

We run the `TPL()` function on just the species names `Full.name` in Taxonstand's bryophytes data, i.e. Taxonstand::TPL(bryophytes$Full.name).

```{r TPL_check_bryophytes, echo= FALSE, warning=FALSE}

#select only head (ease processing speed)

corrected_bryophytes_data <- Taxonstand::TPL(bryophytes_short$Full.name)

selected_corrected_data <- dplyr::select(corrected_bryophytes_data, New.Genus, New.Species, New.Authority)

knitr::kable(selected_corrected_data, caption = "First six rows of corrections of Taxonstand's bryophytes species list with Genus species and authority")
```

## References

Albuquerque, Ulysses Paulino, Patricia Muniz de Medeiros, Washington Soares Ferreira Junior, Taline Cristina da Silva, Rafael Ricardo Vasconcelos da Silva, and Thiago Goncalves-Souza. “Social-Ecological Theory of Maximization: Basic Concepts and Two Initial Models.” Biological Theory, February 11, 2019. <https://doi.org/10.1007/s13752-019-00316-8>.

Albuquerque, Ulysses P., Reinaldo FP Lucena, Julio M. Monteiro, Alissandra TN Florentino, and Cecília de Fatima CBR Almeida. “Evaluating Two Quantitative Ethnobotanical Techniques.” Ethnobotany Research and Applications 4 (2006): 51–60. <http://hdl.handle.net/10125/237>.

Friedman, J., Z. Yaniv, A. Dafni, and D. Palewitch. “A Preliminary Classification of the Healing Potential of Medicinal Plants, Based on a Rational Analysis of an Ethnopharmacological Field Survey among Bedouins in the Negev Desert, Israel.” Journal of Ethnopharmacology 16, no. 2–3 (June 1986): 275–87.

Gaoue, Orou G., Michael A. Coe, Matthew Bond, Georgia Hart, Barnabas C. Seyler, and Heather McMillen. “Theories and Major Hypotheses in Ethnobotany.” Economic Botany 71, no. 3 (September 2017): 269–87. <https://doi.org/10.1007/s12231-017-9389-8>.

Prance, G. T., W. Baleé, B. M. Boom, and R. L. Carneiro. “Quantitative Ethnobotany and the Case for Conservation in Amazonia.” Conservation Biology 1, no. 4 (1987): 296–310.

Reyes-Garcia, V., T. Huanca, V. Vadez, and W. Leonard “Cultural, Practical, and Economic Value of Wild Plants: A Quantitative Study in the Bolivian Amazon.” Economic Botany, 2006.

Tardio, Javier, and Manuel Pardo-de-Santayana. “Cultural Importance Indices: A Comparative Analysis Based on the Useful Wild Plants of Southern Cantabria (Northern Spain)1.” Economic Botany 62, no. 1 (May 2008): 24–39. <https://doi.org/10.1007/s12231-007-9004-5>.

Whitney, Cory W., Joseph Bahati, and J. Gebauer. “Ethnobotany and Agrobiodiversity; Valuation of Plants in the Homegardens of Southwestern Uganda.” Ethnobiology Letters 9, no. 2 (2018): 90–100. <https://doi.org/10.14237/ebl.9.2.2018.503>.


