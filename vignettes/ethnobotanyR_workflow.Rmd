---
title: "Suggested workflow using ethnobotanyR"
author: "Cory Whitney"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: references/Ethnobotany.bib
vignette: >
  %\VignetteIndexEntry{Ethnobotany workflow using ethnobotanyR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# ethnobotanyR 

<p align="center">
<img src="ethnobotanyR.png" height="256" style="background:none; border:none; box-shadow:none;">
</p>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(causaleffect)
library(broom)
library(dplyr)
library(ethnobotanyR)
library(igraph)
library(magrittr)
library(pbapply)
library(purrr)
library(stringr)
library(Taxonstand)
library(tidyr)
library(vegan)
```

## Addressing issues of relevance to communities

It is far better for development related work to be done with, rather than about, communities. Ethnobotany work often concerns people who are faced with uncertain decisions about how to manage natural resources. Ideally the research that we do in ethnobotany should aim to have direct relevance to the human and natural communities that are involved. Well formulated research agendas in ethnobotany are thos ehtta seek to provide clarity for relevant and timely decisions. Trade-offs often have to be made between the natural world and human development. These trade-offs should be discussed and the detriments to either human society or ecology should be mitigated. Our work in ethnobotany can help to make these trade-offs clear and help to support decision making so that it has the best outcomes for society and the natural world. 

We should do our work so that it serves local communities. The best way to make sure that our work is of direct relevance to communities is to start our process with local people, rather than developing our research agenda at our desks we should do it cooperatively with the broad interests of local communities in mind. 

In addition to working closely with communities and generating quality research questions, another, possibly equally important part of ethnobotany is that we are good practitioners. This means attaining as much as possible a mastery of the tools needed for the job. This workflow gives a general overview of one possible process for an ethnobotany study and the tools that may be needed.

## Impact pathway 

Applying docalculus to impact pathways is a new revolutionary way to allow for calculating the causal effects of interventions [@pearlBookWhyNew2018]. Building a causal model of the problem at hand can be useful when working together with communities to define meaningful research questions. Through collaborative and iterative processes of logical explainations about relationships [@whitneyDecisionAnalysisMethods2018] the decision can take the form of a causal decision impact pathway. Such a pathway can be used for generation of a mathematical formula for calclating possible intervention outcomes [@tikkaIdentifyingCausalEffects2017]. 

The example below is a simplified hypothetical analysis of the effect of allowing for forest use (i.e. active practice of ethnobotany uses) on the conservation of a forest given the risk of overextraction and the possible benefit of conservation actions on the part of the users. This can be plotted with the `igraph` package [@igraph].

```{r plot_conservation_decision, fig.width=7, fig.height=7}
#decision impact pathway

conservation_decision <- igraph::graph.formula(UF -+  CA, #use_forests -+ conservation_action,
                                    UF -+  OE, #use_forests -+ overextraction,
                                    OE -+  C, #overextraction -+ conservation,
                                    CA -+  C, #conservation_action -+ conservation,
                   simplify = FALSE)

plot(conservation_decision)
```

The `causal.effect()` function of the `causaleffect` package uses the doCalculus methods to generate a formula for the causal impact pathway [@causaleffect]. This model can be fed with observed values, ethnobotany surveys, focus group discussions and interviews.

```{r}
causaleffect_model <- causaleffect::causal.effect(y = "C", x = "UF", z = NULL, G = conservation_decision, expr = TRUE)
```

```{r get_formula, include=FALSE}
#Concatenate and Print model
cat(causaleffect_model)
```

$P_{C}(UF) = \sum_{CA,OE}*P(C|UF,CA,OE)*P(OE|UF)*P(CA|UF)$

```{r}
#priors use brms!
CA <- 0.5 #conservation_action,
OE <- 0.5 #overextraction,
ProbCgivenUF_CAandOE <- 0.7
ProbOEgivenUF <- 0.1
ProbCAgivenUF <- 0.9

sum(CA,OE)*ProbCgivenUF_CAandOE*ProbOEgivenUF*ProbCAgivenUF
  
```
## Testing various hypotheses in ethnobotany

Users are highly encouraged to familiarize themselves wth ethnobotany theory [@gaoueTheoriesMajorHypotheses2017] and social ecological theory [@albuquerqueSocialEcologicalTheoryMaximization2019]. An overview of this theorhetical background will be helpful in understanding approaches in ethnobotany and formulating useful research questions. 

Annalyses such as Detrended correspondence analysis (DCA) and Principal component analysis (PCA) may be useful for exploratory analysis of ethnobotany data. Such analyses should be used with caution and within the confines of the predetermined research aims and objectives.

### Detrended correspondence analysis (DCA)

Detrended correspondence analysis (DCA) can be used to find the main factors or 'gradients' in large and sparse community datasets. This can be a useful tool for assessing important informant-species-use associations in ethnobotany. Here we use the  dataset presented in `ethnobotanydata` to perform DCA using the `decorana()` function in the `vegan` package [@vegan]. 

The first step is to remove zero value row sums. The DCA can only work with data that is complete (i.e. we remove all NA cases as well as those where the species is listed by an informant but no specific use is recorded). This can be done quickly using the `select()` and `filter_all()` functions of the `dplyr` package [@dplyr] and pipe `%>%` functions of the `magrittr` package [@magrittr].

```{r }
#remove rows with zero rowsums
ethno_data_complete <- ethnobotanydata %>%  
  dplyr::select(-informant, -sp_name) %>% 
  dplyr::filter_all(any_vars(!is.na(.)))%>%
    dplyr::filter_all(any_vars(. != 0))

 ethno_ordination <- vegan::decorana(ethno_data_complete) #This saves ordination results

 
 ethno_ordination
```

Ordination results can be shown with the command `summary()` and the argument for the named ordination, i.e. summary(ethno_ordination in our case). Likewise, ordination scores can be extracted with `scores()`. Calling the `plot()` function on the ordination results will plot the scores from the ordination.

```{r plot_ord, fig.width=7, fig.height=7}
#Plot ordination results
plot(ethno_ordination)
```

## Principal component analysis (PCA)

Principal component analysis (PCA) can be used to create sets of linearly uncorrelated variables from cases of informant-species-use associations. The resulting principal components are linear combinations of variables that are fed in and each contain all observations. We perform PCA using the `broom` [@broom], `tidyr` [@tidyr] and `purrr` [@purrr] packages using the `nest()` function along with the `mutate()` and `map()` functions to operate on the nested columns. This gives a `tibble` with one row and three columns: 1. our original data set, 2. the `prcomp` object and 3. a data frame of principal component values for each observation.

```{r nesting}
nested_ethno_pca <- ethnobotanydata %>% 
  tidyr::nest() %>% 
  dplyr::mutate(pca = purrr::map(data, ~ stats::prcomp(.x %>% 
        dplyr::select(-informant, -sp_name), 
        center = TRUE, scale = TRUE)),
         pca_augmented = map2(pca, data, ~broom::augment(.x, data = .y)))

nested_ethno_pca
```

For PCA model evaluation we can check to see how much variance is explained by each principal component. This tells us how many of the components would be reasonable to assess when analyzing the results. To do this, we can use the data in the `pca_augmented` column of our `nested_ethno_pca` tibble along with `dplyr` [@dplyr] and `magrittr` [@magrittr] functions.

```{r variance_check}

var_exp_tidy <- nested_ethno_pca %>% 
  tidyr::unnest(pca_augmented) %>% 
  dplyr::summarize_at(.vars = vars(contains("PC")), .funs = tibble::lst(var)) %>% 
  tidyr::gather(key = pc, value = variance) %>% 
  dplyr::mutate(var_exp = variance/sum(variance),
         cum_var_exp = cumsum(var_exp),
         pc = stringr::str_replace(pc, ".fitted", ""))

var_exp_tidy
```

The `nrow(var_exp_tidy)` principle components selected explain `sum(var_exp_tidy$var_exp)`% of variance. As a general rule the first few principal components explain much of the variation. To keep the analysis within reasonable bounds it makes sense to select the first four principle components (this choice may change according to the analysis).

```{r select_components}

var_exp <- var_exp_tidy %>% 
  head(4)

var_exp
```

Plot the variance explained and the cumulative variance explained to see trends across components.

```{r plot_pca, fig.width=7, fig.height=7}
var_exp %>% 
  dplyr::rename(
    `Variance Explained` = var_exp,
    `Cumulative Variance Explained` = cum_var_exp
  ) %>% 
  tidyr::gather(key = key, value = value, `Variance Explained`:`Cumulative Variance Explained`) %>% 
  ggplot2::ggplot(ggplot2::aes(pc, value, group = key)) + 
  ggplot2::geom_point() + 
  ggplot2::geom_line() + 
  ggplot2::facet_wrap(~key, scales = "free_y") +
  ggplot2::theme_minimal() +
  ggplot2::lims(y = c(0, 1)) +
  ggplot2::labs(y = "Variance",
       title = "Variance explained by each principal component")

```

## Getting Species names right

A large part of the work of ethnobotany is identification of species. Plant species names change all the time. As botanists learn more about the diversity of plant life the taxonomic record becomes more clear and different species groups are often split or merged. These changes are most accurately, and most timely, dispalyed on The Plant List (TPL <http://www.theplantlist.org/>) maintained by the Missouri Botanical Garden. 

Among the many other functions, the R package Taxonstand can cross-check .csv based lists of species names against the database [@Taxonstand]. Here is an example using just the species names `Full.name` in Taxonstand's `bryophytes` data.

```{r bryophytes_head, echo= FALSE}
data(bryophytes)

 bryophytes_short <- bryophytes %>% 
  head(6)

knitr::kable(bryophytes_short$Full.name, caption = "First six rows of Taxonstand's bryophytes species list")
```

We run the `TPL()` function on just the species names `Full.name` in Taxonstand's bryophytes data, i.e. Taxonstand::TPL(bryophytes$Full.name). The use of this package requires a good internet connection (over 700 kb/second) to connect to the TPL server.

```{r TPL_check_bryophytes, echo= FALSE, warning=FALSE}

#select only head (ease processing speed)

corrected_bryophytes_data <- Taxonstand::TPL(bryophytes_short$Full.name)

selected_corrected_data <- dplyr::select(corrected_bryophytes_data, New.Genus, New.Species, New.Authority)

knitr::kable(selected_corrected_data, caption = "First six rows of corrections of Taxonstand's bryophytes species list with Genus species and authority")
```

## References

